# 本次修改说明

 基于假设，我们需要得到一个趋同的特征向量。那么，我们可以通过计算各阶向量距离中心向量的相似度分数，来定义权重。

#  实验结果

| epoch | mAP  | Rank1 | Rank5 |
| :-----: | :----: | :-----: | :-----: |
|520|78.3%|84.1%|94.6%|
|480|78.3%|84.1%|94.3%|
|440|78.2%|84.2%|94.5%|
|400|78.1%|83.9%|94.5%|
|360|78.4%|84.2%|94.5%|

# 实验总结

​    我们这里用的是余弦相似度来做的，可能存在一个比较大的问题。

​    首先，余弦相似度`cosine`的取值范围为`[-1,1]`。假设一种极端情况，即存在两个向量，一个向量和中心向量极端不同，即`cosine_score0 = -1`，和一个向量和中心向量极端相同，即`cosine_score1 = 1`。

​    那么，在计算权重的时候这两个向量对应的权重为，
$$
w_1 =  \frac{e^1}{e^1+e^-1}=0.88
$$

$$
w_2 = \frac{e^-1}{e^1+e^-1}=0.119
$$

此时对应最差的样本权重还能有`0.119`，显然是不那么理想的。这种情况可能在计算*`score`*的数量多了以后会有所好转。但是，在我们的实验中，数量的急速下降的。所以，这个问题可能在被无限放大。

  另一方面，我又觉得这应该不是实验的主要问题。因为，你想阿我们希望得到一个更有的融合办法并且以平均值来引导。那么这个权重本身就已经反应了向量的变化情况。最重要的是，这个权重向量已经达到了弱化问题特征并强化关键特征的作用了。所以，无论如何这应该都是比直接平均好要的。那么，到底为什么没有让模型涨点呢？

1. 可能和*`softmax`*函数有关（但感觉不是关键的问题）
2. 查一下代码中是否还有其他用一维卷积替代平均的，有可能是他们相互影响导致的。
3. 如果把这个权重放在圆上做，会不会得到一个出其不意的结果？（我觉得这应该是想使用余弦相似度很关键的一步）

  再想想，这个做法是否存在什么逻辑漏洞？这种引导是否存在确切的理论支持？如何验证？基于什么假设？能否再深入的提出做法？

  对于特征融合的假设，实际上你还需要弄清楚一点。即，是否在每个时间区间内，特征的表述都是趋同的？`趋同`的依据是，他们是同一个行人，所以在相同的时间区间内，他们一定能用一个趋同的特征表示。`不趋同`的依据是，这些图片对应的是一个行走的行人，所以在一个短时间内（没有到一个行走周期）动作语义的表示一定不同。那么，如何把握这个度？

  还是回到了寒假那个问题的讨论，即我们要从不变的特征中选出外观特征；从变化的特征中动作语意特征。难的地方主要在于，如何捕捉到变化特征中的动作语义。一方面，要考虑到不是所有的变化特征都能带表动作语义，但是从变化特征中提取动作语义这个工作可以交给卷积神经网络来做。另一方面，我们怎么定义这个`变化特征`是一个很重要的内容！

  马上，我就想到了解决方案，还是用平均值的定义来做。之前，读过一篇将显著性检测用于视频行人重识别的文章。他们用到的一个`templet`的概念，我们也可以加以利用。假设，有两张特征图
$$
F_i^n,F_i+1^n\in R^{C\times W\times H}
$$
可计算平均值`templet`
$$
mean(F_i^n,F_{i+1}^n)=\widehat{A}_{ij}^n,\widehat{A}_{ij}^n \in R^{C \times W \times H}
$$
记`templet`第`i,j`位置的特征向量为，
$$
f_{ij} \in R^{C}
$$
其余两个特征图对应`i,j`位置的特征向量为，
$$
f_{i},f_{j} \in R^{C}
$$
所以，根据我们的思想就可以定义不同特征图位置的`attention mask`。

根据公式
$$
F_{ij}^{n+1}=(\alpha \times F_{i}^{n} + \beta \times F_{j}^{n})^2 + \gamma \times F_{i}^{n} + \delta \times F_{j}^{n}
$$
其中，
$$
\alpha _{ij} = \frac{1}{cosine(f_{ij},f_i)},

\beta _{ij} = \frac{1}{cosine(f_{ij},f_j)}
$$
但这么有可能把一些干扰信息也强化了，所以这可能需要卷积神经网络进一步提取这之中的特征。对整个特征表示进行优化。

以上的给出了接下来实验的大致思路，先实现，再回过头来讨论是否存在问题。

加油，冲上90%。



