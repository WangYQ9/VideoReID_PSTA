# 实验说明


&ensp实验#124和实验#123是一起的对比实验，目的都是将核心公式，
$$
F_{ij}^n = (\alpha \times F_i^n + \beta \times F_j^n)^2 + \gamma \times  F_i^n + \delta \times F_j^n
$$

把$\alpha$和$\beta$的生成和$F_i^n$以及$F_j^n$同时挂上关系。

&ensp在实验#123中的做法是将以$F_i^n$和$F_j^n$为输入的第一层全连接层的输出，$f_i^n$和$f_j^n$相加起来得到$f_{i,j}^n$，作为这两个输入特征图的总特征。然后再用一个全连接层分别得到$\alpha$和$\beta$。公式如下，
$$
f_{i,j}^n = sigmoid(W_{1,1} \times f_i^n) + sigmid(W_{2,1} \times f_j^n)
$$
$$
f_i^{n+1} = ReLU(W_{1,2} \times f_{i,j}^n)
$$
$$
f_j^{n+1} = ReLU(W_{2,2} \times f_{i,j}^n)
$$

&ensp本次实验中将相加改成`合并cat`，即
$$
f_{i,j}^n = Cat\big[Sigmoid(W_{1,1} \times f_i^n), Sigmoid(W_{2,1}\times f_j^n)\big]
$$
$$
f_i^{n+1} = ReLU(W_{1,2}\times f_{i,j}^n)
$$
$$
f_j^{n+1} = ReLU(W_{2,2}\times f_{i,j}^n)
$$

# 实验分析

1.将所有阶特征向量均载入`交叉熵`和`三元组损失函数`的计算。

|epoch|mAP|rank1|rank5|
|:--:|:--:|:--:|:--:|
|360|72.1%|82.4%|92.1%|
|320|72.5%|82.5%|92.0%|
|280|71.9%|81.5%|92.1%|
|240|72.1%|82.3%|92.3%|

2.将所有特征载入`三元组损失函数`,最后一维特征载入`交叉熵`的计算。

|epoch|mAP|rank1|rank5|
|:--:|:--:|:--:|:--:|
|440|73.2%|82.2%|92.6%|
|400|72.9%|82.0%|92.1%|
|360|72.5%|81.8%|92.1%|
|320|72.8%|82.1%|92.3%|

3.将所有特征载入`交叉熵`，最后一维特征载入`三元组损失函数`的计算。

|epoch|mAP|rank1|rank5|
|:--:|:--:|:--:|:--:|
|520|73.1%|82.8%|91.8%|
|480|73.1%|82.5%|91.8%|
|440|73.3%|82.4%|92.1%|
|400|72.9%|82.6%|91.8%|

4. 将最后一维特征按照原来的规律，载入`交叉熵`和`三元组损失函数`

|epoch|mAP|rank1|rank5|
|:--:|:--:|:--:|:--:|
|360|74.1%|82.6%|93.0%|
|320|74.1%|82.8%|93.0%|
|280|74.0%|82.7%|92.7%|
|240|74.2%|82.8%|92.3%|



## 实验特点

  在4个实验中，均出现了损失函数的瓶颈问题。即，损失函数对应的数值几乎没有变化。而且，从`三元组损失函数`的特点看来发现，瓶颈问题对应的正好是等式
$$
L_{BH}(\theta;X)=\sum_{i=1}^P\sum_{a=1}^K\Big[m + max D\big(f_\theta(x_a^i), f_\theta(x_p^i)\big)-minD\big(f_\theta(x_a^i),f_\theta(x_n^j)\big)\Big]_+
$$

中的`m`。说明此时出现了最大的类内距离等于最小的类间距离，即此时的边界是重合的。==这一点可以通过将`margine`设置成零进行验证。== 但还是没有说明，为什么会出现这种情况。我觉得并不一定是三元组的极限导致的。==保留梯度消失的看法==

## 实验方向

1. 交换`交叉熵`和`三元组损失`函数的位置，看是否是真的因为`三元组`损失函数出现瓶颈导致的。
2. 另一个可能的猜测是出现了`梯度消失`，所以可以考虑在一些地方加入非线性激活函数。